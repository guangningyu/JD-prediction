/*
* @Author: shu.wen
* @Date:   2017-04-28 21:38:44
* @Last Modified by:   shu.wen
* @Last Modified time: 2017-05-05 01:15:11
*/

sqlite3.exe  JData.db

.show
.headers on
.separator ","


-- 客户数据
DROP TABLE IF EXISTS JDATA_USER_TBL;
CREATE TABLE  JDATA_USER_TBL (
  USER_ID     INTEGER,
  AGE         TEXT,
  SEX         TEXT,
  USER_LV_CD  INTEGER,
  USER_REG_TM DATE
);


-- 商品属性数据
DROP TABLE IF EXISTS JDATA_PRODUCT_TBL;
CREATE TABLE  JDATA_PRODUCT_TBL (
  SKU_ID     INTEGER,
  A1         TEXT,
  A2         TEXT,
  A3         TEXT,
  CATE       INTEGER,
  BRAND      INTEGER
);




-- 产品评论数据
DROP TABLE IF EXISTS JDATA_COMMENT_TBL;
CREATE TABLE  JDATA_COMMENT_TBL (
  DT                DATE,
  SKU_ID            INTEGER,
  COMMENT_NUM       INTEGER,
  HAS_BAD_COMMENT   INTEGER,
  BAD_COMMENT_RATE  REAL

);




--行为数据
DROP TABLE IF EXISTS JDATA_ACTION_TBL ;
CREATE TABLE  JDATA_ACTION_TBL (
  USER_ID           INTEGER,
  SKU_ID            INTEGER,
  TIME              DATETIME,
  MODEL_ID          INTEGER,
  TYPE              INTEGER,
  CATE              INTEGER,
  BRAND             INTEGER
);




.import /root/data/JData_User_no_header.csv JDATA_USER_TBL
.import /root/data/JData_Product_no_header.csv JDATA_PRODUCT_TBL
.import /root/data/JData_Comment_no_header.csv JDATA_COMMENT_TBL
.import /root/data/JData_Action_All_no_header.csv JDATA_ACTION_TBL


SELECT COUNT() FROM JDATA_USER_TBL;
-- 210642
SELECT COUNT() FROM JDATA_PRODUCT_TBL;
-- 24187
SELECT COUNT() FROM JDATA_COMMENT_TBL;
-- 558552
SELECT COUNT() FROM JDATA_ACTION_TBL;
-- 50601736


-- 准备训练集/测试集 X Y

---- Y: SKU CATE
DROP TABLE IF EXISTS JDATA_LABEL_SKU_0304_TBL;
CREATE TABLE JDATA_LABEL_SKU_0304_TBL AS
  SELECT
    USER_ID
    , SKU_ID
    , MAX(CASE WHEN TYPE = 4 THEN 1 ELSE 0 END) AS Y
  FROM (
    SELECT
      *
    FROM  JDATA_ACTION_TBL
    WHERE
      1=1
      AND TIME >= DATE('2016-04-01')
      AND TIME <  DATE('2016-04-06')
      AND CATE = '8'
      AND TYPE = '4'
  )
  GROUP BY
    USER_ID
    , SKU_ID
;
SELECT COUNT() FROM JDATA_LABEL_SKU_0304_TBL;
-- 934


DROP TABLE IF EXISTS JDATA_LABEL_CATE_0304_TBL;
CREATE TABLE JDATA_LABEL_CATE_0304_TBL AS
  SELECT
    USER_ID
    , MAX(Y) AS Y
  FROM JDATA_LABEL_SKU_0304_TBL
  GROUP BY
    USER_ID
;
SELECT COUNT() FROM JDATA_LABEL_CATE_0304_TBL;
-- 920



---- X
DROP TABLE IF EXISTS JDATA_ACTION_0304_TBL;
CREATE TABLE JDATA_ACTION_0304_TBL AS
  SELECT
    USER_ID
    , SKU_ID
    , TIME
    , MODEL_ID
    , TYPE
    , CATE
    , BRAND
  FROM  JDATA_ACTION_TBL
  WHERE
    1=1
    AND TIME >= DATE('2016-03-01')
    AND TIME <  DATE('2016-04-01')
;
SELECT COUNT() FROM JDATA_ACTION_0304_TBL;
-- 25916191


-- 客户在观察窗口期间所有对第8类的各种行为
DROP TABLE IF EXISTS JDATA_X_CATE_ACTION_0304_TBL;
CREATE TABLE JDATA_X_CATE_ACTION_0304_TBL AS
  SELECT
    USER_ID
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 3) and TYPE = "1" THEN 1 ELSE 0 END) AS USER_CATE_8_TYPE_1_CNT_3
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 3) and TYPE = "2" THEN 1 ELSE 0 END) AS USER_CATE_8_TYPE_2_CNT_3
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 3) and TYPE = "3" THEN 1 ELSE 0 END) AS USER_CATE_8_TYPE_3_CNT_3
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 3) and TYPE = "4" THEN 1 ELSE 0 END) AS USER_CATE_8_TYPE_4_CNT_3
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 3) and TYPE = "5" THEN 1 ELSE 0 END) AS USER_CATE_8_TYPE_5_CNT_3
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 3) and TYPE = "6" THEN 1 ELSE 0 END) AS USER_CATE_8_TYPE_6_CNT_3
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 3) and TYPE = "1" THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_TYPE_1_RATE_3
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 3) and TYPE = "2" THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_TYPE_2_RATE_3
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 3) and TYPE = "3" THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_TYPE_3_RATE_3
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 3) and TYPE = "4" THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_TYPE_4_RATE_3
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 3) and TYPE = "5" THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_TYPE_5_RATE_3
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 3) and TYPE = "6" THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_TYPE_6_RATE_3
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 3) and STRFTIME('%w', TIME) =  '0' THEN 1 ELSE 0 END) AS USER_CATE_8_WEEK_00_CNT_3
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 3) and STRFTIME('%w', TIME) =  '1' THEN 1 ELSE 0 END) AS USER_CATE_8_WEEK_01_CNT_3
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 3) and STRFTIME('%w', TIME) =  '2' THEN 1 ELSE 0 END) AS USER_CATE_8_WEEK_02_CNT_3
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 3) and STRFTIME('%w', TIME) =  '3' THEN 1 ELSE 0 END) AS USER_CATE_8_WEEK_03_CNT_3
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 3) and STRFTIME('%w', TIME) =  '4' THEN 1 ELSE 0 END) AS USER_CATE_8_WEEK_04_CNT_3
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 3) and STRFTIME('%w', TIME) =  '5' THEN 1 ELSE 0 END) AS USER_CATE_8_WEEK_05_CNT_3
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 3) and STRFTIME('%w', TIME) =  '6' THEN 1 ELSE 0 END) AS USER_CATE_8_WEEK_06_CNT_3
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 3) and STRFTIME('%w', TIME) =  '0' THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_WEEK_00_RATE_3
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 3) and STRFTIME('%w', TIME) =  '1' THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_WEEK_01_RATE_3
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 3) and STRFTIME('%w', TIME) =  '2' THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_WEEK_02_RATE_3
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 3) and STRFTIME('%w', TIME) =  '3' THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_WEEK_03_RATE_3
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 3) and STRFTIME('%w', TIME) =  '4' THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_WEEK_04_RATE_3
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 3) and STRFTIME('%w', TIME) =  '5' THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_WEEK_05_RATE_3
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 3) and STRFTIME('%w', TIME) =  '6' THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_WEEK_06_RATE_3
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 3) and STRFTIME('%H', TIME) in ('02', '03', '04', '05', '06', '07', '08' ) THEN 1 ELSE 0 END)   AS USER_CATE_8_HOUR_02_08_CNT_3
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 3) and STRFTIME('%H', TIME) in ('09', '10', '11', '12' ) THEN 1 ELSE 0 END)                     AS USER_CATE_8_HOUR_09_12_CNT_3
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 3) and STRFTIME('%H', TIME) in ('13', '14', '15', '16', '17', '18' ) THEN 1 ELSE 0 END)         AS USER_CATE_8_HOUR_13_18_CNT_3
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 3) and STRFTIME('%H', TIME) in ('19', '20', '21', '22', '23', '00', '01' ) THEN 1 ELSE 0 END)   AS USER_CATE_8_HOUR_19_01_CNT_3
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 3) and STRFTIME('%H', TIME) in ('02', '03', '04', '05', '06', '07', '08' ) THEN 1 ELSE 0 END) *1.0 / COUNT()  AS USER_CATE_8_HOUR_02_08_RATE_3
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 3) and STRFTIME('%H', TIME) in ('09', '10', '11', '12' ) THEN 1 ELSE 0 END)                   *1.0 / COUNT()  AS USER_CATE_8_HOUR_09_12_RATE_3
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 3) and STRFTIME('%H', TIME) in ('13', '14', '15', '16', '17', '18' ) THEN 1 ELSE 0 END)       *1.0 / COUNT()  AS USER_CATE_8_HOUR_13_18_RATE_3
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 3) and STRFTIME('%H', TIME) in ('19', '20', '21', '22', '23', '00', '01' ) THEN 1 ELSE 0 END) *1.0 / COUNT()  AS USER_CATE_8_HOUR_19_01_RATE_3

    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 7) and TYPE = "1" THEN 1 ELSE 0 END) AS USER_CATE_8_TYPE_1_CNT_7
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 7) and TYPE = "2" THEN 1 ELSE 0 END) AS USER_CATE_8_TYPE_2_CNT_7
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 7) and TYPE = "3" THEN 1 ELSE 0 END) AS USER_CATE_8_TYPE_3_CNT_7
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 7) and TYPE = "4" THEN 1 ELSE 0 END) AS USER_CATE_8_TYPE_4_CNT_7
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 7) and TYPE = "5" THEN 1 ELSE 0 END) AS USER_CATE_8_TYPE_5_CNT_7
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 7) and TYPE = "6" THEN 1 ELSE 0 END) AS USER_CATE_8_TYPE_6_CNT_7
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 7) and TYPE = "1" THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_TYPE_1_RATE_7
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 7) and TYPE = "2" THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_TYPE_2_RATE_7
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 7) and TYPE = "3" THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_TYPE_3_RATE_7
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 7) and TYPE = "4" THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_TYPE_4_RATE_7
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 7) and TYPE = "5" THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_TYPE_5_RATE_7
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 7) and TYPE = "6" THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_TYPE_6_RATE_7
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 7) and STRFTIME('%w', TIME) =  '0' THEN 1 ELSE 0 END) AS USER_CATE_8_WEEK_00_CNT_7
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 7) and STRFTIME('%w', TIME) =  '1' THEN 1 ELSE 0 END) AS USER_CATE_8_WEEK_01_CNT_7
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 7) and STRFTIME('%w', TIME) =  '2' THEN 1 ELSE 0 END) AS USER_CATE_8_WEEK_02_CNT_7
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 7) and STRFTIME('%w', TIME) =  '3' THEN 1 ELSE 0 END) AS USER_CATE_8_WEEK_03_CNT_7
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 7) and STRFTIME('%w', TIME) =  '4' THEN 1 ELSE 0 END) AS USER_CATE_8_WEEK_04_CNT_7
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 7) and STRFTIME('%w', TIME) =  '5' THEN 1 ELSE 0 END) AS USER_CATE_8_WEEK_05_CNT_7
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 7) and STRFTIME('%w', TIME) =  '6' THEN 1 ELSE 0 END) AS USER_CATE_8_WEEK_06_CNT_7
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 7) and STRFTIME('%w', TIME) =  '0' THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_WEEK_00_RATE_7
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 7) and STRFTIME('%w', TIME) =  '1' THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_WEEK_01_RATE_7
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 7) and STRFTIME('%w', TIME) =  '2' THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_WEEK_02_RATE_7
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 7) and STRFTIME('%w', TIME) =  '3' THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_WEEK_03_RATE_7
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 7) and STRFTIME('%w', TIME) =  '4' THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_WEEK_04_RATE_7
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 7) and STRFTIME('%w', TIME) =  '5' THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_WEEK_05_RATE_7
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 7) and STRFTIME('%w', TIME) =  '6' THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_WEEK_06_RATE_7
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 7) and STRFTIME('%H', TIME) in ('02', '03', '04', '05', '06', '07', '08' ) THEN 1 ELSE 0 END)   AS USER_CATE_8_HOUR_02_08_CNT_7
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 7) and STRFTIME('%H', TIME) in ('09', '10', '11', '12' ) THEN 1 ELSE 0 END)                     AS USER_CATE_8_HOUR_09_12_CNT_7
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 7) and STRFTIME('%H', TIME) in ('13', '14', '15', '16', '17', '18' ) THEN 1 ELSE 0 END)         AS USER_CATE_8_HOUR_13_18_CNT_7
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 7) and STRFTIME('%H', TIME) in ('19', '20', '21', '22', '23', '00', '01' ) THEN 1 ELSE 0 END)   AS USER_CATE_8_HOUR_19_01_CNT_7
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 7) and STRFTIME('%H', TIME) in ('02', '03', '04', '05', '06', '07', '08' ) THEN 1 ELSE 0 END) *1.0 / COUNT()  AS USER_CATE_8_HOUR_02_08_RATE_7
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 7) and STRFTIME('%H', TIME) in ('09', '10', '11', '12' ) THEN 1 ELSE 0 END)                   *1.0 / COUNT()  AS USER_CATE_8_HOUR_09_12_RATE_7
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 7) and STRFTIME('%H', TIME) in ('13', '14', '15', '16', '17', '18' ) THEN 1 ELSE 0 END)       *1.0 / COUNT()  AS USER_CATE_8_HOUR_13_18_RATE_7
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 7) and STRFTIME('%H', TIME) in ('19', '20', '21', '22', '23', '00', '01' ) THEN 1 ELSE 0 END) *1.0 / COUNT()  AS USER_CATE_8_HOUR_19_01_RATE_7

    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 15) and TYPE = "1" THEN 1 ELSE 0 END) AS USER_CATE_8_TYPE_1_CNT_15
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 15) and TYPE = "2" THEN 1 ELSE 0 END) AS USER_CATE_8_TYPE_2_CNT_15
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 15) and TYPE = "3" THEN 1 ELSE 0 END) AS USER_CATE_8_TYPE_3_CNT_15
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 15) and TYPE = "4" THEN 1 ELSE 0 END) AS USER_CATE_8_TYPE_4_CNT_15
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 15) and TYPE = "5" THEN 1 ELSE 0 END) AS USER_CATE_8_TYPE_5_CNT_15
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 15) and TYPE = "6" THEN 1 ELSE 0 END) AS USER_CATE_8_TYPE_6_CNT_15
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 15) and TYPE = "1" THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_TYPE_1_RATE_15
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 15) and TYPE = "2" THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_TYPE_2_RATE_15
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 15) and TYPE = "3" THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_TYPE_3_RATE_15
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 15) and TYPE = "4" THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_TYPE_4_RATE_15
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 15) and TYPE = "5" THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_TYPE_5_RATE_15
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 15) and TYPE = "6" THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_TYPE_6_RATE_15
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 15) and STRFTIME('%w', TIME) =  '0' THEN 1 ELSE 0 END) AS USER_CATE_8_WEEK_00_CNT_15
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 15) and STRFTIME('%w', TIME) =  '1' THEN 1 ELSE 0 END) AS USER_CATE_8_WEEK_01_CNT_15
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 15) and STRFTIME('%w', TIME) =  '2' THEN 1 ELSE 0 END) AS USER_CATE_8_WEEK_02_CNT_15
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 15) and STRFTIME('%w', TIME) =  '3' THEN 1 ELSE 0 END) AS USER_CATE_8_WEEK_03_CNT_15
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 15) and STRFTIME('%w', TIME) =  '4' THEN 1 ELSE 0 END) AS USER_CATE_8_WEEK_04_CNT_15
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 15) and STRFTIME('%w', TIME) =  '5' THEN 1 ELSE 0 END) AS USER_CATE_8_WEEK_05_CNT_15
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 15) and STRFTIME('%w', TIME) =  '6' THEN 1 ELSE 0 END) AS USER_CATE_8_WEEK_06_CNT_15
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 15) and STRFTIME('%w', TIME) =  '0' THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_WEEK_00_RATE_15
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 15) and STRFTIME('%w', TIME) =  '1' THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_WEEK_01_RATE_15
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 15) and STRFTIME('%w', TIME) =  '2' THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_WEEK_02_RATE_15
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 15) and STRFTIME('%w', TIME) =  '3' THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_WEEK_03_RATE_15
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 15) and STRFTIME('%w', TIME) =  '4' THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_WEEK_04_RATE_15
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 15) and STRFTIME('%w', TIME) =  '5' THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_WEEK_05_RATE_15
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 15) and STRFTIME('%w', TIME) =  '6' THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_WEEK_06_RATE_15
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 15) and STRFTIME('%H', TIME) in ('02', '03', '04', '05', '06', '07', '08' ) THEN 1 ELSE 0 END)   AS USER_CATE_8_HOUR_02_08_CNT_15
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 15) and STRFTIME('%H', TIME) in ('09', '10', '11', '12' ) THEN 1 ELSE 0 END)                     AS USER_CATE_8_HOUR_09_12_CNT_15
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 15) and STRFTIME('%H', TIME) in ('13', '14', '15', '16', '17', '18' ) THEN 1 ELSE 0 END)         AS USER_CATE_8_HOUR_13_18_CNT_15
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 15) and STRFTIME('%H', TIME) in ('19', '20', '21', '22', '23', '00', '01' ) THEN 1 ELSE 0 END)   AS USER_CATE_8_HOUR_19_01_CNT_15
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 15) and STRFTIME('%H', TIME) in ('02', '03', '04', '05', '06', '07', '08' ) THEN 1 ELSE 0 END) *1.0 / COUNT()  AS USER_CATE_8_HOUR_02_08_RATE_15
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 15) and STRFTIME('%H', TIME) in ('09', '10', '11', '12' ) THEN 1 ELSE 0 END)                   *1.0 / COUNT()  AS USER_CATE_8_HOUR_09_12_RATE_15
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 15) and STRFTIME('%H', TIME) in ('13', '14', '15', '16', '17', '18' ) THEN 1 ELSE 0 END)       *1.0 / COUNT()  AS USER_CATE_8_HOUR_13_18_RATE_15
    , SUM(CASE WHEN (JULIANDAY('2016-04-01') - JULIANDAY(TIME) <= 15) and STRFTIME('%H', TIME) in ('19', '20', '21', '22', '23', '00', '01' ) THEN 1 ELSE 0 END) *1.0 / COUNT()  AS USER_CATE_8_HOUR_19_01_RATE_15


    , SUM(CASE WHEN TYPE = "1" THEN 1 ELSE 0 END) AS USER_CATE_8_TYPE_1_CNT
    , SUM(CASE WHEN TYPE = "2" THEN 1 ELSE 0 END) AS USER_CATE_8_TYPE_2_CNT
    , SUM(CASE WHEN TYPE = "3" THEN 1 ELSE 0 END) AS USER_CATE_8_TYPE_3_CNT
    , SUM(CASE WHEN TYPE = "4" THEN 1 ELSE 0 END) AS USER_CATE_8_TYPE_4_CNT
    , SUM(CASE WHEN TYPE = "5" THEN 1 ELSE 0 END) AS USER_CATE_8_TYPE_5_CNT
    , SUM(CASE WHEN TYPE = "6" THEN 1 ELSE 0 END) AS USER_CATE_8_TYPE_6_CNT
    , SUM(CASE WHEN TYPE = "1" THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_TYPE_1_RATE
    , SUM(CASE WHEN TYPE = "2" THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_TYPE_2_RATE
    , SUM(CASE WHEN TYPE = "3" THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_TYPE_3_RATE
    , SUM(CASE WHEN TYPE = "4" THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_TYPE_4_RATE
    , SUM(CASE WHEN TYPE = "5" THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_TYPE_5_RATE
    , SUM(CASE WHEN TYPE = "6" THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_TYPE_6_RATE
    , SUM(CASE WHEN STRFTIME('%w', TIME) =  '0' THEN 1 ELSE 0 END) AS USER_CATE_8_WEEK_00_CNT
    , SUM(CASE WHEN STRFTIME('%w', TIME) =  '1' THEN 1 ELSE 0 END) AS USER_CATE_8_WEEK_01_CNT
    , SUM(CASE WHEN STRFTIME('%w', TIME) =  '2' THEN 1 ELSE 0 END) AS USER_CATE_8_WEEK_02_CNT
    , SUM(CASE WHEN STRFTIME('%w', TIME) =  '3' THEN 1 ELSE 0 END) AS USER_CATE_8_WEEK_03_CNT
    , SUM(CASE WHEN STRFTIME('%w', TIME) =  '4' THEN 1 ELSE 0 END) AS USER_CATE_8_WEEK_04_CNT
    , SUM(CASE WHEN STRFTIME('%w', TIME) =  '5' THEN 1 ELSE 0 END) AS USER_CATE_8_WEEK_05_CNT
    , SUM(CASE WHEN STRFTIME('%w', TIME) =  '6' THEN 1 ELSE 0 END) AS USER_CATE_8_WEEK_06_CNT
    , SUM(CASE WHEN STRFTIME('%w', TIME) =  '0' THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_WEEK_00_RATE
    , SUM(CASE WHEN STRFTIME('%w', TIME) =  '1' THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_WEEK_01_RATE
    , SUM(CASE WHEN STRFTIME('%w', TIME) =  '2' THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_WEEK_02_RATE
    , SUM(CASE WHEN STRFTIME('%w', TIME) =  '3' THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_WEEK_03_RATE
    , SUM(CASE WHEN STRFTIME('%w', TIME) =  '4' THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_WEEK_04_RATE
    , SUM(CASE WHEN STRFTIME('%w', TIME) =  '5' THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_WEEK_05_RATE
    , SUM(CASE WHEN STRFTIME('%w', TIME) =  '6' THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_CATE_8_WEEK_06_RATE
    , SUM(CASE WHEN STRFTIME('%H', TIME) in ('02', '03', '04', '05', '06', '07', '08' ) THEN 1 ELSE 0 END)   AS USER_CATE_8_HOUR_02_08_CNT
    , SUM(CASE WHEN STRFTIME('%H', TIME) in ('09', '10', '11', '12' ) THEN 1 ELSE 0 END)                     AS USER_CATE_8_HOUR_09_12_CNT
    , SUM(CASE WHEN STRFTIME('%H', TIME) in ('13', '14', '15', '16', '17', '18' ) THEN 1 ELSE 0 END)         AS USER_CATE_8_HOUR_13_18_CNT
    , SUM(CASE WHEN STRFTIME('%H', TIME) in ('19', '20', '21', '22', '23', '00', '01' ) THEN 1 ELSE 0 END)   AS USER_CATE_8_HOUR_19_01_CNT
    , SUM(CASE WHEN STRFTIME('%H', TIME) in ('02', '03', '04', '05', '06', '07', '08' ) THEN 1 ELSE 0 END) *1.0 / COUNT()  AS USER_CATE_8_HOUR_02_08_RATE
    , SUM(CASE WHEN STRFTIME('%H', TIME) in ('09', '10', '11', '12' ) THEN 1 ELSE 0 END)                   *1.0 / COUNT()  AS USER_CATE_8_HOUR_09_12_RATE
    , SUM(CASE WHEN STRFTIME('%H', TIME) in ('13', '14', '15', '16', '17', '18' ) THEN 1 ELSE 0 END)       *1.0 / COUNT()  AS USER_CATE_8_HOUR_13_18_RATE
    , SUM(CASE WHEN STRFTIME('%H', TIME) in ('19', '20', '21', '22', '23', '00', '01' ) THEN 1 ELSE 0 END) *1.0 / COUNT()  AS USER_CATE_8_HOUR_19_01_RATE


  FROM JDATA_ACTION_0304_TBL
  WHERE
    1=1
    AND CATE = '8'
  GROUP BY
    USER_ID
;
SELECT COUNT() FROM JDATA_X_CATE_ACTION_0304_TBL;
-- 88808



-- 客户在观察窗口期间所有品类和行为汇总
DROP TABLE IF EXISTS JDATA_X_CATE_USER_TYPE_HIST_0304_TBL ;
CREATE TABLE JDATA_X_CATE_USER_TYPE_HIST_0304_TBL AS
  SELECT
    USER_ID
    , SUM(CASE WHEN TYPE = "1" THEN 1 ELSE 0 END) AS USER_TYPE_1_CNT
    , SUM(CASE WHEN TYPE = "2" THEN 1 ELSE 0 END) AS USER_TYPE_2_CNT
    , SUM(CASE WHEN TYPE = "3" THEN 1 ELSE 0 END) AS USER_TYPE_3_CNT
    , SUM(CASE WHEN TYPE = "4" THEN 1 ELSE 0 END) AS USER_TYPE_4_CNT
    , SUM(CASE WHEN TYPE = "5" THEN 1 ELSE 0 END) AS USER_TYPE_5_CNT
    , SUM(CASE WHEN TYPE = "6" THEN 1 ELSE 0 END) AS USER_TYPE_6_CNT

    , SUM(CASE WHEN TYPE = "1" THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_TYPE_1_RATE
    , SUM(CASE WHEN TYPE = "2" THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_TYPE_2_RATE
    , SUM(CASE WHEN TYPE = "3" THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_TYPE_3_RATE
    , SUM(CASE WHEN TYPE = "4" THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_TYPE_4_RATE
    , SUM(CASE WHEN TYPE = "5" THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_TYPE_5_RATE
    , SUM(CASE WHEN TYPE = "6" THEN 1 ELSE 0 END)*1.0 / COUNT() AS USER_TYPE_6_RATE

    , SUM(CASE WHEN TYPE = "4" THEN 1 ELSE 0 END)*1.0 / SUM(CASE WHEN TYPE = "1" THEN 1 ELSE 0 END) AS USER_TYPE_1_4_RATE
    , SUM(CASE WHEN TYPE = "4" THEN 1 ELSE 0 END)*1.0 / SUM(CASE WHEN TYPE = "2" THEN 1 ELSE 0 END) AS USER_TYPE_2_4_RATE
    , SUM(CASE WHEN TYPE = "4" THEN 1 ELSE 0 END)*1.0 / SUM(CASE WHEN TYPE = "3" THEN 1 ELSE 0 END) AS USER_TYPE_3_4_RATE
    , SUM(CASE WHEN TYPE = "4" THEN 1 ELSE 0 END)*1.0 / SUM(CASE WHEN TYPE = "5" THEN 1 ELSE 0 END) AS USER_TYPE_5_4_RATE
    , SUM(CASE WHEN TYPE = "4" THEN 1 ELSE 0 END)*1.0 / SUM(CASE WHEN TYPE = "6" THEN 1 ELSE 0 END) AS USER_TYPE_6_4_RATE

  FROM JDATA_ACTION_0304_TBL
  GROUP BY
    USER_ID
;

SELECT COUNT() FROM JDATA_X_CATE_USER_TYPE_HIST_0304_TBL;
-- 96087



-- MST TBL
DROP TABLE IF EXISTS JDATA_X_CATE_MST_0304_TBL ;
CREATE TABLE JDATA_X_CATE_MST_0304_TBL AS
  SELECT
    A.*
    , B.USER_TYPE_1_CNT
    , B.USER_TYPE_2_CNT
    , B.USER_TYPE_3_CNT
    , B.USER_TYPE_4_CNT
    , B.USER_TYPE_5_CNT
    , B.USER_TYPE_6_CNT
    , B.USER_TYPE_1_RATE
    , B.USER_TYPE_2_RATE
    , B.USER_TYPE_3_RATE
    , B.USER_TYPE_4_RATE
    , B.USER_TYPE_5_RATE
    , B.USER_TYPE_6_RATE
    , B.USER_TYPE_1_4_RATE
    , B.USER_TYPE_2_4_RATE
    , B.USER_TYPE_3_4_RATE
    , B.USER_TYPE_5_4_RATE
    , B.USER_TYPE_6_4_RATE
    , C.AGE
    , C.SEX
    , C.USER_LV_CD
    , CAST(ROUND((JULIANDAY('2016-04-01') - JULIANDAY(C.USER_REG_TM))/30) AS INT) AS USER_REG_M_CNT
    , CASE WHEN E.Y = 1 THEN 1 ELSE 0 END AS Y

  FROM JDATA_X_CATE_ACTION_0304_TBL A
  LEFT JOIN JDATA_X_CATE_USER_TYPE_HIST_0304_TBL B
  ON A.USER_ID = B.USER_ID
  LEFT JOIN JDATA_USER_TBL C
  ON A.USER_ID = C.USER_ID
  LEFT JOIN JDATA_LABEL_CATE_0304_TBL E
  ON A.USER_ID = E.USER_ID
;

SELECT COUNT() FROM JDATA_X_CATE_MST_0304_TBL;
-- 88808

.output JDATA_X_CATE_MST_0304.csv
SELECT * FROM JDATA_X_CATE_MST_0304_TBL ;
.output stdout




------------------------------ sku level 宽表 -------------------------------------------------------------------

-- SKU_ID在观察窗口期间所有品类和行为汇总
DROP TABLE IF EXISTS JDATA_X_CATE_SKU_TYPE_HIST_0304_TBL ;
CREATE TABLE JDATA_X_CATE_SKU_TYPE_HIST_0304_TBL AS
  SELECT
    SKU_ID
    , SUM(CASE WHEN TYPE = "1" THEN 1 ELSE 0 END) AS SKU_TYPE_1_CNT
    , SUM(CASE WHEN TYPE = "2" THEN 1 ELSE 0 END) AS SKU_TYPE_2_CNT
    , SUM(CASE WHEN TYPE = "3" THEN 1 ELSE 0 END) AS SKU_TYPE_3_CNT
    , SUM(CASE WHEN TYPE = "4" THEN 1 ELSE 0 END) AS SKU_TYPE_4_CNT
    , SUM(CASE WHEN TYPE = "5" THEN 1 ELSE 0 END) AS SKU_TYPE_5_CNT
    , SUM(CASE WHEN TYPE = "6" THEN 1 ELSE 0 END) AS SKU_TYPE_6_CNT

    , SUM(CASE WHEN TYPE = "1" THEN 1 ELSE 0 END)*1.0 / COUNT() AS SKU_TYPE_1_RATE
    , SUM(CASE WHEN TYPE = "2" THEN 1 ELSE 0 END)*1.0 / COUNT() AS SKU_TYPE_2_RATE
    , SUM(CASE WHEN TYPE = "3" THEN 1 ELSE 0 END)*1.0 / COUNT() AS SKU_TYPE_3_RATE
    , SUM(CASE WHEN TYPE = "4" THEN 1 ELSE 0 END)*1.0 / COUNT() AS SKU_TYPE_4_RATE
    , SUM(CASE WHEN TYPE = "5" THEN 1 ELSE 0 END)*1.0 / COUNT() AS SKU_TYPE_5_RATE
    , SUM(CASE WHEN TYPE = "6" THEN 1 ELSE 0 END)*1.0 / COUNT() AS SKU_TYPE_6_RATE

    , SUM(CASE WHEN TYPE = "4" THEN 1 ELSE 0 END)*1.0 / SUM(CASE WHEN TYPE = "1" THEN 1 ELSE 0 END) AS SKU_TYPE_1_4_RATE
    , SUM(CASE WHEN TYPE = "4" THEN 1 ELSE 0 END)*1.0 / SUM(CASE WHEN TYPE = "2" THEN 1 ELSE 0 END) AS SKU_TYPE_2_4_RATE
    , SUM(CASE WHEN TYPE = "4" THEN 1 ELSE 0 END)*1.0 / SUM(CASE WHEN TYPE = "3" THEN 1 ELSE 0 END) AS SKU_TYPE_3_4_RATE
    , SUM(CASE WHEN TYPE = "4" THEN 1 ELSE 0 END)*1.0 / SUM(CASE WHEN TYPE = "5" THEN 1 ELSE 0 END) AS SKU_TYPE_5_4_RATE
    , SUM(CASE WHEN TYPE = "4" THEN 1 ELSE 0 END)*1.0 / SUM(CASE WHEN TYPE = "6" THEN 1 ELSE 0 END) AS SKU_TYPE_6_4_RATE

  FROM JDATA_ACTION_0304_TBL
  GROUP BY
    SKU_ID
;
SELECT COUNT() FROM JDATA_X_CATE_SKU_TYPE_HIST_0304_TBL;
-- 23753




-- SKU_ID在观察窗口期间 comment
DROP TABLE IF EXISTS JDATA_X_SKU_COMMENT_0304_TBL ;
CREATE TABLE JDATA_X_SKU_COMMENT_0304_TBL AS
  SELECT
    SKU_ID
    , COMMENT_NUM
    , HAS_BAD_COMMENT
    , BAD_COMMENT_RATE
  FROM JDATA_COMMENT_TBL
  WHERE
    1=1
    AND DT = DATE('2016-03-28')
;
SELECT COUNT() FROM JDATA_X_SKU_COMMENT_0304_TBL;
-- 46546
